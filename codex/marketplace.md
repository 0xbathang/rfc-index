---
slug: 
title: CODEX-MARKETPLACE
name: Codex Storage Marketplace
status: raw
tags: codex
editor: 
contributors:
  
---

## Abstract

This specification describes a method for Codex hosts and client nodes to participate in a storage marketplace. 
The goal is to create a storage marketplace that promotes durability.

## Motivation
The Codex network aims to create a peer-to-peer storage engine with strong data availability, 
data persistence guarantees and node storage incentives.
To reach this goal, a data availability and retrieval mechanism is needed.
Support for light clients, like mobile devices should also be embraced.
The protocol should remove complexity to allow for simple implementation and 
simplify incentive mechanisms.

## Semantics 

The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in [2119](https://www.ietf.org/rfc/rfc2119.txt).

### Definitions

| Terminology  | Description |
| --------------- | --------- |
| Storage Nodes | A Codex node that provides storage services to the marketplace.|
| Validator Nodes | A Codex node that collects, validates and submits proofs to reward or penalize other storage nodes or validator nodes. |
| Regular Nodes | The main Codex client that interacts with other nodes to locate and retrieve data. Also considered to be an ephemeral node (light client) |
| Slots | An agreement between storage nodes and regular nodes to store data |

### Storage Request

A regular node can request storage of data by opening a storage contract on the Codex blockchain. 
The storage contract is opened in the marketplace via the blockchain, and 
the requested data is split into blocks with erasure coding.
Blocks of data are placed into slots to begin the request,
see [slots](#slots) discussed below. 

The requester MUST provide `duration` of the storage request along with the appropriate `reward`,
payment for request, before the contract is created. 
Once a contract is created, 
all slots MUST be filled by storage nodes before the request is officially started.
If the request does not attract enough storage nodes after a pre-defined network timeout,
which is defined by a Codex node as `expire`,
the request SHOULD be canceled.
If canceled, `collateral` SHOULD be returned to any storage nodes and 
`reward` returned to the requester.
The requester MAY create a new request with different values to attract storage nodes.

The requester SHOULD initiate the contract with the following values:

```nim

proc requestStorage (): {} =
  # content identifier
  byte32 cid = 1
  # Tokens from the requester to reward storage nodes
  UInt256 reward = 2
  # Amount of tokens required for collateral by storage nodes
  UInt256 collateral = 3
  # Frequency that proofs are checked by validator nodes
  byte proofProbability = 4
  # Amount of desired time for stoageRequest
  UInt256 duration = 5
  # The requester can choose amount of spreading of data to storage nodes
  uint dispersal = 6
  # Minimum Number of storage hosts 
  uint nodes = 7

}

```

`cid` 

- MUST be a sha2-256 hash (length of 32 bytes),
is a content identifier for the requested data to be stored
- MUST be generated by the requester, a regular node

`reward`

- SHOULD be a token known to the network.
- it MUST be paid directly to storage nodes that agree to storage contract

`collateral`

All storage nodes MUST provide token collateral before being able to fulfill a storage contract.
The collateral will be taken to punish a storage node when it does not follow the contract.
The following conditions MUST be fulfilled in a Codex storage contract
- failing to provide proof of storage periodically, the RECOMMENDED method for proofs is [Proof-of-Data-Possession](https://hackmd.io/2uRBltuIT7yX0CyczJevYg?view).
- a portion of `collateral` MUST be offered as a reward to validator nodes,
and a portion SHOULD be offered as a reward to storage nodes that repair [slots](#slots).

`proofProbability`

Storage nodes are REQUIRED to provide proofs of storage that are verified by validator nodes.
The requester SHOULD provide the value for the frequency of proofs provided by storage nodes.

`duration`

- Once the `reward` has depleted from periodic storage node payment,
the storage request SHOULD end.
The requester MAY renew the storage request by creating a new request with the same `cid` value.
- Data MAY be considered lost during contract `duration` if storage nodes fail to provide storage proofs and
no other storage nodes decide to fill empty slots, see [slots](#slots) below.

`dispersal`

- Storage nodes MUST not allowed to fill all slots in a request.
- Requester SHOULD provide dispersal value

### Slots

After a storage request is made, 
the requester's Codex node will create slots using erasure coding.
Each slot will contain a data block being stored.
- Storage Nodes MUST provide token collateral and proof of storage to fill a slot
- If storage nodes fail to provide proof of storage in a given period,
the slot will become empty and the host assigned to that slot MUST forfeit its `collateral`.
Other storage nodes can earn the forfeited `collateral` by providing new proof of storage and `collateral`,
this is referred to as repairing the empty slot.

-----------

        proof &                                 proof &
      collateral   proof          missed      collateral               missed
            |        |              |               |                    |
            v        v              v               v                    v
            -------------------------------------------------------------------
     slot:  |///////////////////////|               |////////////////////|
            -------------------------------------------------------------------
                                    |                                    |
                                    v                                    v
                                collateral                           collateral
                                  lost                                 lost



            ---------------- time ---------------->


## Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).

## References 

1. [Proof-of-Data-Possession](https://hackmd.io/2uRBltuIT7yX0CyczJevYg?view)
2. [Codex market implementation](https://github.com/codex-storage/nim-codex/blob/master/codex/market.nim)

